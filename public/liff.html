<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px 20px; background-color: #f4f7f6; }
    .status-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn { background: #00b900; color: white; border: none; padding: 12px 25px; border-radius: 8px; display: none; margin: 20px auto; cursor: pointer; }
    .debug-info { font-size: 11px; color: #666; margin-top: 20px; word-break: break-all; text-align: left; background: #eee; padding: 15px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="status-card">
    <div id="status">
      <h3>üåÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</h3>
      <p>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Ñ‡πà‡∏∞‡πÄ‡∏õ‡∏£‡∏°</p>
    </div>
    <button id="closeBtn" class="btn" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
  </div>

  <div id="debug" class="debug-info">üìç Debug Status: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div>

  <script>
    const statusDiv = document.getElementById("status");
    const debugDiv = document.getElementById("debug");

    async function main() {
      try {
        debugDiv.innerHTML = "üìç Debug: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏° liff.init...";
        await liff.init({ liffId: "2008944819-hKnqP5yy" });
        
        if (!liff.isLoggedIn()) { 
          debugDiv.innerHTML = "üìç Debug: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login...";
          liff.login({ redirectUri: window.location.href }); 
          return; 
        }

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");
        
        debugDiv.innerHTML = `üìç Debug: Login ‡πÅ‡∏•‡πâ‡∏ß | Token = ${token ? '‚úÖ ‡∏û‡∏ö' : '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö'}`;

        const profile = await liff.getProfile();
        statusDiv.innerHTML = `<h3>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ${profile.displayName}</h3><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πâ‡∏°...</p>`;

        // ‚ú® 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠‡∏Ñ‡πà‡∏∞)
        const targetUrl = `${window.location.origin}/liff/consume?token=${token}&userId=${profile.userId}`;

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Debug (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô)
        debugDiv.innerHTML += `<br>üöÄ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${targetUrl}`;

        // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Fetch)
        const response = await fetch(targetUrl);
        const resultText = await response.text();

        debugDiv.innerHTML += `<br>üì° ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Server: ${response.status} ${response.statusText}`;

        if (response.ok) {
          statusDiv.innerHTML = `<h3>‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3><p>${resultText}</p>`;
          setTimeout(() => liff.closeWindow(), 4000);
        } else {
          statusDiv.innerHTML = `<h3>‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3><p>${resultText}</p>`;
          document.getElementById("closeBtn").style.display = "block";
        }

      } catch (err) {
        statusDiv.innerHTML = `<h3>‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</h3><p style="color:red;">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${err.message}</p>`;
        debugDiv.innerHTML += `<br>üî¥ ERROR ‡∏™‡∏î‡πÜ: ${err.stack}`;
        document.getElementById("closeBtn").style.display = "block";
      }
    }
    main();
  </script>
</body>
</html>
