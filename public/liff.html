<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninety Wash - ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: #fff;
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        /* üåü ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
        .point-display {
            background: linear-gradient(135deg, #06c755, #05a848);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }
        .point-display span { font-size: 14px; opacity: 0.9; }
        .point-display div { font-size: 24px; font-weight: bold; margin-top: 5px; }

        h3 { margin: 0 0 20px 0; color: #333; text-align: center; font-size: 18px; }

        /* üé® Grid Layout 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        /* ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á (2 ‡∏™‡πà‡∏ß‡∏ô) + ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (1 ‡∏™‡πà‡∏ß‡∏ô) */
        .input-manual {
            grid-column: span 2;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #eee;
            border-radius: 12px;
            outline: none;
            text-align: center;
        }
        .input-manual:focus { border-color: #06c755; }

        .btn-confirm {
            background-color: #06c755;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-confirm:active { transform: scale(0.95); background-color: #05a848; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ */
        .btn-preset {
            background: white;
            border: 2px solid #f0f0f0;
            padding: 18px 0;
            font-size: 20px;
            font-weight: bold;
            border-radius: 15px;
            color: #333;
            cursor: pointer;
        }
        .btn-preset:active { background: #f0f0f0; transform: scale(0.95); }

        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none; justify-content: center; align-items: center;
            border-radius: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="point-display">
        <span>‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πâ‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
        <div id="current-points">... ‡πÅ‡∏ï‡πâ‡∏°</div>
    </div>

    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ‚ú®</h3>

    <div class="grid-container">
        <input type="number" id="manualInput" class="input-manual" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á...">
        <button class="btn-confirm" onclick="handleManual()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>

        <button class="btn-preset" onclick="startRedeem(20)">20</button>
        <button class="btn-preset" onclick="startRedeem(30)">30</button>
        <button class="btn-preset" onclick="startRedeem(40)">40</button>

        <button class="btn-preset" onclick="startRedeem(50)">50</button>
        <button class="btn-preset" onclick="startRedeem(60)">60</button>
        <button class="btn-preset" onclick="startRedeem(70)">70</button>

        <button class="btn-preset" onclick="startRedeem(80)">80</button>
        <button class="btn-preset" onclick="startRedeem(90)">90</button>
        <button class="btn-preset" onclick="startRedeem(100)">100</button>
    </div>

    <div id="loading" class="loading-overlay">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
</div>

<script>
    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    async function initLIFF() {
        try {
            await liff.init({ liffId: "YOUR_LIFF_ID" }); // ‚ö†Ô∏è ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡∏£‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            fetchPoints(profile.userId);
        } catch (err) { console.error("LIFF Init Error", err); }
    }

    // 2. ‡∏î‡∏∂‡∏á‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å Backend (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ API ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞)
    async function fetchPoints(userId) {
        try {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà API ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡∏£‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠ endpoint)
            const res = await fetch(`/api/get-points?userId=${userId}`);
            const data = await res.json();
            document.getElementById('current-points').innerText = `${data.points || 0} ‡πÅ‡∏ï‡πâ‡∏°`;
        } catch (e) { document.getElementById('current-points').innerText = "0 ‡πÅ‡∏ï‡πâ‡∏°"; }
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)
    function handleManual() {
        const amount = document.getElementById('manualInput').value;
        if (!amount || amount <= 0) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚ú®");
            return;
        }
        startRedeem(amount);
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏´‡∏±‡∏Å‡πÅ‡∏ï‡πâ‡∏°
    async function startRedeem(amount) {
        try {
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô
            const result = await liff.scanCode();
            const machineId = result.value;

            if (machineId) {
                document.getElementById('loading').style.display = 'flex';
                const profile = await liff.getProfile();
                
                // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏£‡∏°‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô index.js
                window.location.href = `/liff/redeem-execute?userId=${profile.userId}&amount=${amount}&machine_id=${machineId}`;
            }
        } catch (err) {
            console.log("Scan cancelled or error", err);
        }
    }

    initLIFF();
</script>

</body>
</html>
