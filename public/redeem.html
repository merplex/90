<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover">

<title>‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 16px;
    display: flex;
    justify-content: center;
  }

  .card {
    background: #fff;
    border-radius: 20px;
    padding: 24px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 10px 30px rgba(0,0,0,.08);
  }

  .step { display: none; }
  .step.active { display: block; }

  .spinner {
    font-size: 48px;
    animation: spin 1.2s linear infinite;
    margin: 40px 0;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  h3 {
    margin-top: 0;
    font-size: 18px;
    color: #333;
  }

  .point {
    font-size: 40px;
    font-weight: bold;
    color: #06c755;
    margin: 8px 0;
  }

  .money {
    font-size: 16px;
    color: #555;
    margin-bottom: 16px;
  }

  .numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    margin-top: 20px;
  }

  .numpad button {
    height: 72px;
    font-size: 26px;
    border-radius: 18px;
    border: none;
    background: #f1f3f5;
    font-weight: 600;
  }

  .confirm {
    margin-top: 24px;
    height: 60px;
    width: 100%;
    font-size: 20px;
    border-radius: 16px;
    border: none;
    background: #06c755;
    color: white;
    font-weight: bold;
  }

  .confirm:disabled {
    background: #bdbdbd;
  }
</style>
</head>

<body>

<div class="card">

  <!-- STEP 1 -->
  <div id="step-connect" class="step active">
    <div class="spinner">üîÑ</div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE</p>
  </div>

  <!-- STEP 2 -->
  <div id="step-load" class="step">
    <div class="spinner">‚è≥</div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πâ‡∏°</p>
  </div>

  <!-- STEP 3 -->
  <div id="step-redeem" class="step">
    <h3>‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
    <div class="point" id="balancePoint">0</div>

    <div class="money">
      ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: <b id="usePoint">0</b><br>
      = ‡πÄ‡∏á‡∏¥‡∏ô <b id="useMoney">0</b> ‡∏ö‡∏≤‡∏ó
    </div>

    <div class="numpad">
      <button onclick="add(1)">1</button>
      <button onclick="add(2)">2</button>
      <button onclick="add(3)">3</button>
      <button onclick="add(4)">4</button>
      <button onclick="add(5)">5</button>
      <button onclick="add(6)">6</button>
      <button onclick="add(7)">7</button>
      <button onclick="add(8)">8</button>
      <button onclick="add(9)">9</button>
      <button onclick="clearAll()">C</button>
      <button onclick="add(0)">0</button>
      <button onclick="back()">‚Üê</button>
    </div>

    <button class="confirm" id="confirmBtn" onclick="confirmRedeem()" disabled>
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
    </button>
  </div>

</div>

<script>
const API = ""; // ‡∏ñ‡πâ‡∏≤ backend ‡∏Ñ‡∏ô‡∏•‡∏∞ domain ‡πÉ‡∏™‡πà https://xxx.up.railway.app

let balance = 0;
let input = "";
let userId = "";

function show(id) {
  document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function main() {
  // 1Ô∏è‚É£ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  show("step-connect");

  // 2Ô∏è‚É£ ‡∏Å‡∏±‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
  const timeout = setTimeout(() => {
    if (document.getElementById("step-connect").classList.contains("active")) {
      alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà");
      liff.closeWindow();
    }
  }, 8000);

  // 3Ô∏è‚É£ init LIFF
  await liff.init({ liffId: "2008944819-N4ozrStq" });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  clearTimeout(timeout); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å

  // 4Ô∏è‚É£ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  show("step-load");

  const profile = await liff.getProfile();
  userId = profile.userId; // global

  const res = await fetch(`/balance?userId=${userId}`);
  if (!res.ok) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    liff.closeWindow();
    return;
  }

  const data = await res.json();
  balance = data.balance;

  document.getElementById("balancePoint").innerText = balance;

  // 5Ô∏è‚É£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  show("step-redeem");
}  show("step-connect");

  await liff.init({ liffId: "2008944819-N4ozrStq" });

  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  show("step-load");

  setTimeout(() => {
  if (document.getElementById("step-connect").classList.contains("active")) {
    alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà");
    liff.closeWindow();
  }
  }, 8000);

  const profile = await liff.getProfile();
  userId = profile.userId; // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß global  // ‚úÖ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞

  // ‚úÖ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ GET /balance ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏á‡∏ñ‡∏≤‡∏°
  const res = await fetch(`/balance?userId=${userId}`);
  if (!res.ok) {
    alert("‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  const data = await res.json();

  balance = data.balance; // ‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å backend
  document.getElementById("balancePoint").innerText = balance;

  show("step-redeem");
}

function add(n) {
  input += n;
  update();
}

function back() {
  input = input.slice(0, -1);
  update();
}

function clearAll() {
  input = "";
  update();
}

function update() {
  const p = Number(input || 0);
  document.getElementById("usePoint").innerText = p;
  document.getElementById("useMoney").innerText = p;

  document.getElementById("confirmBtn").disabled =
    p <= 0 || p > balance;
}

async function confirmRedeem() {
  if (!liff.isInClient()) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE");
    return;
  }

  try {
  const result = await liff.scanCodeV2();
  const qrData = JSON.parse(result.value);
  await redeemPoint(qrData);
} catch (err) {
  alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô");
  liff.closeWindow(); // üëà ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
}
}

async function redeemPoint(qrData) {
  const res = await fetch(`${API}/redeem`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      line_user_id: userId,
      use_point: Number(input),
      machine_id: qrData.machine_id,
      amount: qrData.amount,
      nonce: qrData.nonce,
      expire: qrData.expire
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error || "‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return;
  }

  alert(`üéâ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${data.used} ‡πÅ‡∏ï‡πâ‡∏°\n‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${data.balance} ‡πÅ‡∏ï‡πâ‡∏°`);
  liff.closeWindow();
}

main();
</script>

</body>
</html>