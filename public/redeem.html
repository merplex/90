<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover">

<title>‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  padding: 16px;
  background: #f4f6f8;
  display: flex;
  justify-content: center;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 24px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}

.step { display: none; }
.step.active { display: block; }

.spinner {
  font-size: 42px;
  margin: 40px 0;
  text-align: center;
}

h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

.point {
  font-size: 42px;
  font-weight: bold;
  color: #06c755;
}

.money {
  margin: 12px 0;
  color: #555;
}

.numpad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  margin-top: 20px;
}

.numpad button {
  height: 72px;
  font-size: 26px;
  border-radius: 18px;
  border: none;
  background: #f1f3f5;
  font-weight: 600;
}

.confirm {
  margin-top: 24px;
  height: 60px;
  width: 100%;
  font-size: 20px;
  border-radius: 16px;
  border: none;
  background: #06c755;
  color: white;
  font-weight: bold;
}

.confirm:disabled {
  background: #bdbdbd;
}
</style>
</head>

<body>

<div class="card">

  <!-- STEP CONNECT -->
  <div id="step-connect" class="step active">
    <div class="spinner">üîÑ</div>
    <p style="text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE</p>
  </div>

  <!-- STEP LOAD -->
  <div id="step-load" class="step">
    <div class="spinner">‚è≥</div>
    <p style="text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°</p>
  </div>

  <!-- STEP REDEEM -->
  <div id="step-redeem" class="step">
    <h3>‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
    <div class="point" id="balancePoint">0</div>

    <div class="money">
      ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: <b id="usePoint">0</b><br>
      = ‡πÄ‡∏á‡∏¥‡∏ô <b id="useMoney">0</b> ‡∏ö‡∏≤‡∏ó
    </div>

    <div class="numpad">
      <button onclick="add(1)">1</button>
      <button onclick="add(2)">2</button>
      <button onclick="add(3)">3</button>
      <button onclick="add(4)">4</button>
      <button onclick="add(5)">5</button>
      <button onclick="add(6)">6</button>
      <button onclick="add(7)">7</button>
      <button onclick="add(8)">8</button>
      <button onclick="add(9)">9</button>
      <button onclick="clearAll()">C</button>
      <button onclick="add(0)">0</button>
      <button onclick="back()">‚Üê</button>
    </div>

    <button class="confirm" id="confirmBtn" onclick="confirmRedeem()" disabled>
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
    </button>
  </div>

</div>

<script>
const LIFF_ID = "2008944819-N4ozrStq";

let balance = 0;
let input = "";
let userId = "";

function show(id) {
  document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
function fetchWithTimeout(url, options = {}, timeout = 8000) {
  return Promise.race([
    fetch(url, options),
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error("timeout")), timeout)
    )
  ]);
}
async function main() {
  try {
    show("step-connect");

    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    show("step-load");

    const profile = await liff.getProfile();
    userId = profile.userId;

    const res = await fetchWithTimeout(
    `/api/balance?userId=${userId}`
    );

    const data = await res.json();
    balance = data.balance || 0;

    document.getElementById("balancePoint").innerText = balance;
    show("step-redeem");

  } catch (err) {
    console.error("LIFF ERROR:", err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Rich Menu");
    liff.closeWindow();
  }
}

/* ===== keypad ===== */
function add(n) { input += n; update(); }
function back() { input = input.slice(0, -1); update(); }
function clearAll() { input = ""; update(); }

function update() {
  const p = Number(input || 0);
  document.getElementById("usePoint").innerText = p;
  document.getElementById("useMoney").innerText = p;
  document.getElementById("confirmBtn").disabled = p <= 0 || p > balance;
}

/* ===== redeem ===== */
async function confirmRedeem() {
  try {
    const result = await liff.scanCodeV2();
    const qrData = JSON.parse(result.value);

    const res = await fetch(`/api/redeem`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        line_user_id: userId,
        use_point: Number(input),
        nonce: qrData.nonce
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    alert(`üéâ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${data.used} ‡πÅ‡∏ï‡πâ‡∏°\n‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${data.balance} ‡πÅ‡∏ï‡πâ‡∏°`);
    liff.closeWindow();

  } catch (err) {
    alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    liff.closeWindow();
  }
}

main();
</script>
</body>
</html>