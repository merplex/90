<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           user-scalable=no,
           viewport-fit=cover">

<title>‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

body {
  margin: 0;
  padding: 16px;
  background: #f4f6f8;
  display: flex;
  justify-content: center;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 24px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 10px 30px rgba(0,0,0,.08);
}

.step { display: none; }
.step.active { display: block; }

.spinner {
  font-size: 42px;
  margin: 40px 0;
  text-align: center;
}

h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

.point {
  font-size: 42px;
  font-weight: bold;
  color: #06c755;
}

.money {
  margin: 12px 0;
  color: #555;
}

.numpad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  margin-top: 20px;
}

.numpad button {
  height: 72px;
  font-size: 26px;
  border-radius: 18px;
  border: none;
  background: #f1f3f5;
  font-weight: 600;
}

.confirm {
  margin-top: 24px;
  height: 60px;
  width: 100%;
  font-size: 20px;
  border-radius: 16px;
  border: none;
  background: #06c755;
  color: white;
  font-weight: bold;
}

.confirm:disabled {
  background: #bdbdbd;
}
</style>
</head>

<body>

<div class="card">

  <!-- STEP CONNECT -->
  <div id="step-connect" class="step active">
    <div class="spinner">üîÑ</div>
    <p style="text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE</p>
  </div>

  <!-- STEP LOAD -->
  <div id="step-load" class="step">
    <div class="spinner">‚è≥</div>
    <p style="text-align:center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°</p>
  </div>

  <!-- STEP REDEEM -->
  <div id="step-redeem" class="step">
    <h3>‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
    <div class="point" id="balancePoint">0</div>

    <div class="money">
      ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: <b id="usePoint">0</b><br>
      = ‡πÄ‡∏á‡∏¥‡∏ô <b id="useMoney">0</b> ‡∏ö‡∏≤‡∏ó
    </div>

    <div class="numpad">
      <button onclick="add(1)">1</button>
      <button onclick="add(2)">2</button>
      <button onclick="add(3)">3</button>
      <button onclick="add(4)">4</button>
      <button onclick="add(5)">5</button>
      <button onclick="add(6)">6</button>
      <button onclick="add(7)">7</button>
      <button onclick="add(8)">8</button>
      <button onclick="add(9)">9</button>
      <button onclick="clearAll()">C</button>
      <button onclick="add(0)">0</button>
      <button onclick="back()">‚Üê</button>
    </div>

    <button class="confirm" id="confirmBtn" onclick="confirmRedeem()" disabled>
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
    </button>
  </div>

</div>

<script>
async function main() {
  try {
    alert("STEP 1: start main");

    await liff.init({ liffId: "2008944819-N4ozrStq" });
    alert("STEP 2: liff.init OK");

    if (!liff.isInClient()) {
      alert("STEP 3: NOT in LINE client");
      return;
    }
    alert("STEP 3: in LINE client");

    if (!liff.isLoggedIn()) {
      alert("STEP 4: NOT logged in");
      liff.login({ redirectUri: location.href });
      return;
    }
    alert("STEP 4: logged in");

    alert("STEP 5: before getProfile");
    const profile = await liff.getProfile();
    alert("STEP 6: getProfile OK");

    userId = profile.userId;
    alert("STEP 7: userId = " + userId);

    const res = await fetch(`/balance?userId=${userId}`);
    alert("STEP 8: fetch balance status = " + res.status);

    const data = await res.json();
    alert("STEP 9: balance = " + data.balance);

    document.getElementById("balancePoint").innerText = data.balance;
    show("step-redeem");

  } catch (err) {
    alert("‚ùå ERROR: " + err.message);
    console.error(err);
    liff.closeWindow();
  }
}

main();
</script>
</body>
</html>